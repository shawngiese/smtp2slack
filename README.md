# smtp2slack

## Overview
Node.js based bridge that receives SMTP messages and then forwards them to Slack. You could also configure Slack to be your endpoint for SMTP messages but then you are limited to the formatting options. By reformatting the mail as a webhook you can customize how the message appears in Slack. Direct all SMTP messages from Information Hub and System Console to smtp2slack.

## Assumptions
* If running this code locally (useful for debug) install node.js on your computer.
* You have a Slack team account with sufficient rights to add a an incoming WebHook.
* You have installed git on your computer (so NPM install will work).
* You have an Information Hub 16 server installed and the username/password in this code matches an account on your server.
* If you want alerts you need to also install System Console and send messages to smtp2slack.

## Usage

![](/resources/mobileMessage.PNG)

### Run locally
Running the chatbot locally, from your laptop, is very useful for debugging. All of the console output will appear in the terminal you are using to run node. This is also useful if you have resources you want your chatbot to use that are not publically available on the Internet.

1. Get your Slack Webhook URL from the Manage > Custom Integrations > Incoming WebHooks page of your Slack Team.

** In Windows set the token as an environmental variable with the command:

 ```
    set SLACK_WEBURL=<YOUR_SLACK_TOKEN>
	echo %SLACK_WEBURL%
 ```    
Otherwise replace the following line with your Slack WebHook url: 'https://hooks.slack.com/services/'+ webhookurl,
**Do not upload your WebHook URL to a public repository.

2. Download smtp2slack from GitHub and uncompress it to a folder.

3. Run 'npm install' in the root of the chatbot folder to install dependencies.

5. Run SMTP2slack with the command `node smtp2slack.js`

6. Backup and then replace C:\OpenText\InformationHub\modules\BIRTiHub\iHub\shared\config\acnotification.xml with \resources\acnotification.xml. This reformats the emails sent from Information Hub.

7. Backup and then add the following XML to acserverconfig.xml at C:\OpenText\InformationHub\modules\BIRTiHub\iHub\shared\config\:

 ```
<SMTPServers>
	<SMTPServer
		Name="smtp2slack"
		Greeting="HELO"
		SMTPPort="25"
		SenderName="OpenText IHub notification"
		SMTPHostName="localhost"
		SenderAddress="iHub@example.com"/>
</SMTPServers>
 ```
8. Restart Information Hub
9. Add an email address for the Administrator account so that emails are sent.	

Things are looking good if the console prints something like:

	warn: Python is not available. Dkim and spf checking is disabled.
	warn: Either spamassassin or spamc are not available. Spam score computation is disabled.
	info: Mailin Smtp server listening on port 25
	


### Test SMTP message
1. Schedule a report job to run right now.
	. Optionally add a Headline name for the scheduled report.
	. Optionally add a Version name for the report.
2. Set the Notification to send me an email notification with no attachement.
3. Choose Finish to start the job.

Your terminal should show the email that was received. Your Slack channel should show an entry for the generated report. A link is also generated but it only works if the Information Hub server is accessible from where you are reading the Slack message.

### Alerts from System Console
These instructions assume that the System Console is installed on the same server that the Information Hub is installed. If the servers are installed on different computers, replace localhost with the correct hostname.

1. Log in to System Console http://localhost:8500/sysconsole. If you are using a trial license and there is a warning that the SSL connection is not safe, it is because the security certificate is autogenerated. 
2. In Clustrs > DefaultCluster choose Add Cluster Node.
3. Enter in the hostname and choose OK.
4. In Settings > Email Settings set the following parameters:
	. Email Server Type = mail.smtp.host
	. Email Server = localhost
	. Email Address = support@example.com
5. Choose Save and choose OK if asked to confirm the change.
6. In Clusters > DefaultCluster > Alerts, choose Add alert and set the following parameters:
	. Attribute Name = Days until license expires"
	. Condition = >=
	. Threshold = 0
	. Email = support@example.com
	. Alert Name = "Days until the trial license expires"
	. Choose OK
7. Add an email address to an existing alert so that the message is sent using SMTP. For example edit the Server Used CPU Perc Alert >= 90 alert and add an email address such as support@example.com.
	

## License

See the [LICENSE](LICENSE.md) file (MIT).



